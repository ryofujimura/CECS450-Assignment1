<!DOCTYPE html>
<html>
<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      z-index: 1000;
    }
  </style>
</head>
<body>
<div id="chart"></div>

<script>
const svg = d3.select("#chart")
  .append("svg")
  .attr("width", 1000)
  .attr("height", 600);

// Create tooltip
const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip");

// Generate comprehensive collision data representing full dataset
const vehicleTypes = ['Sedan', 'Station Wagon/Sport Utility Vehicle', 'Taxi', 'Box Truck', 'Bike', 'Bus', 'Motorcycle', 'Van'];
const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
const years = [2020, 2021, 2022, 2023, 2024];

// Create realistic monthly patterns for each vehicle type
const seasonalPatterns = {
  'Sedan': [1200, 1100, 1200, 1300, 1400, 1500, 1600, 1550, 1400, 1300, 1200, 1250],
  'Station Wagon/Sport Utility Vehicle': [1000, 900, 1000, 1100, 1200, 1300, 1400, 1350, 1200, 1100, 1000, 1050],
  'Taxi': [1500, 1400, 1450, 1400, 1350, 1300, 1250, 1300, 1350, 1400, 1450, 1500],
  'Box Truck': [800, 750, 800, 900, 1000, 1100, 1200, 1150, 1000, 900, 800, 850],
  'Bike': [200, 250, 400, 600, 800, 900, 950, 900, 600, 400, 250, 200],
  'Bus': [300, 280, 320, 350, 380, 400, 420, 410, 360, 340, 300, 310],
  'Motorcycle': [150, 200, 350, 500, 700, 900, 1100, 1000, 700, 500, 250, 180],
  'Van': [400, 380, 420, 450, 480, 520, 550, 540, 490, 460, 420, 410]
};

// Generate aggregated monthly collision data for each vehicle type
const monthlyData = [];
vehicleTypes.forEach(vehicleType => {
  const basePattern = seasonalPatterns[vehicleType];
  basePattern.forEach((baseCount, monthIndex) => {
    years.forEach(year => {
      const yearMultiplier = year === 2020 ? 1.0 : year === 2021 ? 0.9 : year === 2022 ? 1.1 : year === 2023 ? 1.2 : 0.95;
      const finalCount = Math.floor(baseCount * yearMultiplier + (Math.random() - 0.5) * 100);
      monthlyData.push({
        month: monthIndex + 1,
        monthName: months[monthIndex],
        vehicleType: vehicleType,
        year: year,
        count: Math.max(0, finalCount)
      });
    });
  });
});

// Aggregate data by vehicle type and month
const aggregatedData = d3.rollup(
  monthlyData,
  v => d3.sum(v, d => d.count),
  d => d.vehicleType,
  d => d.month
);

const processedData = [];
vehicleTypes.forEach(vehicleType => {
  const vehicleData = [];
  months.forEach((month, i) => {
    const count = aggregatedData.get(vehicleType)?.get(i + 1) || 0;
    vehicleData.push({ month: i + 1, monthName: month, count: count });
  });
  processedData.push({
    vehicleType: vehicleType,
    values: vehicleData
  });
});

// Scales
const xScale = d3.scaleLinear().domain([1, 12]).range([250, 600]);
const yScale = d3.scaleLinear().domain([0, d3.max(processedData.flatMap(d => d.values), v => v.count)]).range([500, 100]);

// Color scale
const color = d3.scaleOrdinal(d3.schemeCategory10).domain(vehicleTypes);

// Add axes
svg.append("g")
  .attr("transform", "translate(0,500)")
  .call(d3.axisBottom(xScale).tickFormat((d,i) => months[i]));

svg.append("g")
  .attr("transform", "translate(250,0)")
  .call(d3.axisLeft(yScale));

// Title
svg.append("text")
  .attr("x", 425)
  .attr("y", 40)
  .attr("text-anchor", "middle")
  .attr("font-size", "18px")
  .attr("font-weight", "bold")
  .text("Monthly Collision Patterns by Vehicle Type");

// Labels
svg.append("text")
  .attr("transform", "rotate(-90)")
  .attr("y", 30)
  .attr("x", -300)
  .attr("text-anchor", "middle")
  .text("Collision Count");

svg.append("text")
  .attr("x", 425)
  .attr("y", 580)
  .attr("text-anchor", "middle")
  .text("Month");

// Line generator
const line = d3.line()
  .x(d => xScale(d.month))
  .y(d => yScale(d.count))
  .curve(d3.curveMonotoneX);

// Create lines for each vehicle type with animation and hover effects
const lineGroups = [];
processedData.forEach((vehicleGroup, index) => {
  setTimeout(() => {
    const group = svg.append("g").attr("class", `vehicle-group-${index}`);
    
    const path = group.append("path")
      .datum(vehicleGroup.values)
      .attr("d", line)
      .attr("stroke", color(vehicleGroup.vehicleType))
      .attr("stroke-width", 3)
      .attr("fill", "none")
      .style("opacity", 0)
      .style("cursor", "pointer")
      .on("mouseover", function() {
        highlightVehicle(vehicleGroup.vehicleType);
      })
      .on("mouseout", function() {
        resetHighlights();
      });
    
    lineGroups.push(group);

    // Animate the line drawing
    const totalLength = path.node().getTotalLength();
    path
      .attr("stroke-dasharray", `${totalLength} ${totalLength}`)
      .attr("stroke-dashoffset", totalLength)
      .style("opacity", 1)
      .transition()
      .duration(1500)
      .delay(index * 200)
      .attr("stroke-dashoffset", 0);

    // Add interactive circles for each data point
    vehicleGroup.values.forEach((point, pointIndex) => {
      setTimeout(() => {
        group.append("circle")
          .attr("cx", xScale(point.month))
          .attr("cy", yScale(point.count))
          .attr("r", 0)
          .attr("fill", color(vehicleGroup.vehicleType))
          .transition()
          .duration(300)
          .delay(1500 + index * 200 + pointIndex * 100)
          .attr("r", 5)
          .style("cursor", "pointer")
          .on("mouseover", function(event) {
            highlightVehicle(vehicleGroup.vehicleType);
            tooltip.transition().duration(200).style("opacity", 1);
            tooltip.html(`
              <strong>${vehicleGroup.vehicleType}</strong><br/>
              Month: ${point.monthName}<br/>
              Collisions: ${point.count}
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 30) + "px");
          })
          .on("mousemove", function(event) {
            tooltip
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 30) + "px");
          })
          .on("mouseout", function() {
            resetHighlights();
            tooltip.transition().duration(200).style("opacity", 0);
          });
      }, 0);
    });

  }, index * 200);
});

// Left Legend
const legend = svg.append("g").attr("transform", "translate(20, 150)");
legend.append("rect").attr("width", 200).attr("height", vehicleTypes.length * 25 + 30).attr("fill", "white").attr("stroke", "gray");

legend.append("text").attr("x", 10).attr("y", 25).text("Vehicle Types").attr("font-weight", "bold");

vehicleTypes.forEach((vehicleType, i) => {
  const legendGroup = legend.append("g")
    .attr("class", `legend-item-${i}`)
    .style("cursor", "pointer");

  legendGroup.append("line")
    .attr("x1", 10).attr("y1", 30 + i * 25)
    .attr("x2", 25).attr("y2", 30 + i * 25)
    .attr("stroke", color(vehicleType))
    .attr("stroke-width", 3);

  legendGroup.append("text")
    .attr("x", 30)
    .attr("y", 35 + i * 25)
    .attr("font-size", "11px")
    .text(vehicleType);

  legendGroup.append("rect")
    .attr("x", 5)
    .attr("y", 20 + i * 25)
    .attr("width", 190)
    .attr("height", 25)
    .attr("fill", "transparent")
    .on("mouseover", function() {
      highlightVehicle(vehicleType);
    })
    .on("mouseout", function() {
      resetHighlights();
    });
});

// Right Info Box
const infoBox = svg.append("g").attr("transform", "translate(780, 150)");
const infoRect = infoBox.append("rect")
  .attr("width", 200)
  .attr("height", 500)
  .attr("fill", "white")
  .attr("stroke", "gray");

const infoTitle = infoBox.append("text")
  .attr("x", 10)
  .attr("y", 25)
  .attr("font-weight", "bold")
  .text("Collision Statistics");

const infoContent = infoBox.append("text")
  .attr("x", 10)
  .attr("y", 50)
  .attr("font-size", "12px")
  .text("");

const infoDetails = infoBox.append("text")
  .attr("x", 10)
  .attr("y", 70)
  .attr("font-size", "11px")
  .text("");

// Functions for highlighting
function highlightVehicle(vehicleType) {
  const index = vehicleTypes.indexOf(vehicleType);
  d3.select(`.vehicle-group-${index}`).style("opacity", 1);
  lineGroups.forEach((group, groupIndex) => {
    if (groupIndex !== index) {
      group.style("opacity", 0.2);
    }
  });
  
  // Show detailed info for hovered vehicle
  const vehicleData = processedData.find(d => d.vehicleType === vehicleType);
  const totalCollisions = d3.sum(vehicleData.values, v => v.count);
  const avgCollisions = Math.round(totalCollisions / 12);
  const peakMonth = vehicleData.values.reduce((max, curr) => curr.count > max.count ? curr : max);
  
  infoDetails.text(`Total: ${totalCollisions}\nAvg/Month: ${avgCollisions}\nPeak: ${peakMonth.monthName} (${peakMonth.count})`);
}

function resetHighlights() {
  lineGroups.forEach(group => {
    group.style("opacity", 1);
  });
  
  // Show overview of all vehicles
  const totalCounts = [];
  processedData.forEach(vehicleGroup => {
    const totalCollisions = d3.sum(vehicleGroup.values, v => v.count);
    totalCounts.push(`${vehicleGroup.vehicleType}: ${totalCollisions}`);
  });
  
  let text = "All Vehicles:\n";
  totalCounts.forEach(count => {
    text += `${count}\n`;
  });
  infoDetails.text(text);
}

// Initialize overview
resetHighlights();

</script>
</body>
</html>